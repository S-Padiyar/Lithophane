<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Litho3D | Designer</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    :root {
      --dark-bg: #1e272e;
      --light-bg: #f1f2f6;
      --white:   #ffffff;
      --accent:  #34ace0;
      --accent-dark: #227093;
      --cta:     #ff6b6b;
      --cta-dark:#ee5253;
      --text:    #2f3542;
      --text-light: #555;
      --radius:  12px;
      --gap:     24px;
      --transition-fast: 0.25s;
      --transition-slow: 0.5s;
      --shadow-light: rgba(0,0,0,0.08);
      --shadow-strong: rgba(0,0,0,0.2);
      --success: #2ecc71;
      --error: #e74c3c;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background: var(--light-bg); color: var(--text); line-height: 1.6; padding-top: 70px; }
    a { text-decoration: none; color: inherit; }

    header { position: fixed; top: 0; left: 0; width: 100%; background: linear-gradient(90deg, var(--dark-bg), var(--accent-dark)); box-shadow: 0 4px 12px var(--shadow-strong); z-index: 1000; }
    .navbar { max-width: 1200px; margin: auto; display: flex; align-items: center; justify-content: space-between; padding: 1rem var(--gap); font-family: 'Montserrat', sans-serif; }
    .logo { color: #fff; font-size: 1.5rem; font-weight: 600; margin-left: 3rem; }
    .nav-links { list-style: none; display: flex; gap: var(--gap); align-items: center; }
    .nav-links li { position: relative; }

    .nav-links a { color: #fff; padding: 0.5rem 0; font-weight: 500; transition: color var(--transition-fast); }
    .nav-links a:not(.cta)::after { content: ''; position: absolute; left: 0; bottom: -2px; width: 0; height: 2px; background: var(--accent); transition: width var(--transition-fast); }
    .nav-links a:not(.cta):hover { color: var(--accent); }
    .nav-links a:not(.cta):hover::after { width: 100%; }
    .nav-links .cta { padding: 0.5rem 1rem; border-radius: var(--radius); background: var(--cta); box-shadow: 0 4px 8px var(--shadow-strong); transition: transform var(--transition-fast) ease-in-out, box-shadow var(--transition-fast) ease-in-out, background var(--transition-fast); }
    .nav-links .cta:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 8px 16px var(--shadow-strong); background: var(--cta-dark); }

    .hamburger { display: none; cursor: pointer; flex-direction: column; gap: 6px; }
    .bar { width: 28px; height: 3px; background: #fff; border-radius: 3px; transition: all var(--transition-fast) ease-in-out; }
    @media(max-width:768px) {
      .nav-links { position: absolute; top: 64px; left: 0; background: var(--dark-bg); flex-direction: column; width: 100%; padding: 1.5rem; display: none; transform: translateX(100%); transition: transform var(--transition-fast) ease-in-out; }
      .nav-links.active { display: flex; transform: translateX(0); }
      .hamburger { display: flex; }
      .hamburger.active .bar:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); background: var(--accent); }
      .hamburger.active .bar:nth-child(2) { transform: scale(0.1) rotate(360deg); opacity: 0; }
      .hamburger.active .bar:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); background: var(--accent); }
    }

    .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); padding: 0.8rem 1.6rem; border-radius: var(--radius); font-family: 'Montserrat', sans-serif; font-size: 0.9rem; color: #fff; z-index: 3000; display: none; box-shadow: 0 4px 12px var(--shadow-strong); transition: opacity var(--transition-fast) ease-in-out, transform var(--transition-fast) ease-in-out; }
    .notification.success { display: block; background: var(--success); opacity: 1; transform: translateX(-50%) translateY(0); }
    .notification.error { display: block; background: var(--error); opacity: 1; transform: translateX(-50%) translateY(0); }
    .notification.hide { opacity: 0; transform: translateX(-50%) translateY(-20px); }

    section { padding: 100px var(--gap) 60px; }
    section:nth-child(odd) { background: var(--white); }
    section:nth-child(even){ background: var(--light-bg); }
    h2 { text-align: center; font-family: 'Montserrat', sans-serif; font-size: 2.25rem; font-weight: 600; color: var(--text); position: relative; margin-bottom: 0.5rem; }
    h2::after { content: ''; display: block; width: 80px; height: 4px; background: var(--accent); margin: 8px auto 0; border-radius: 2px; }
    p.lead { max-width: 900px; margin: 1rem auto 2rem; color: var(--text-light); text-align: center; }

    .designer-wrap { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 380px 1fr; gap: var(--gap); align-items: start; }
    @media(max-width: 1024px){ .designer-wrap { grid-template-columns: 1fr; } }

    .panel { background: var(--white); border-radius: var(--radius); box-shadow: 0 4px 12px var(--shadow-light); padding: 1rem; }
    .panel h3 { font-family: 'Montserrat', sans-serif; color: var(--accent-dark); margin-bottom: 0.5rem; }

    .field { display: grid; grid-template-columns: 1fr 120px; gap: 10px; align-items: center; margin: 10px 0; }
    .field.wide { grid-template-columns: 1fr; }
    .field label { font-size: 0.95rem; color: var(--text); }
    .field input[type="number"], .field input[type="range"], .field input[type="text"], .field select { width: 100%; padding: 0.6rem 0.7rem; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; }
    .field input[type="checkbox"] { transform: scale(1.2); }

    .btn { display: inline-block; position: relative; padding: 0.6rem 1.2rem; font-family: 'Montserrat', sans-serif; font-weight: 600; color: #fff; overflow: hidden; border-radius: var(--radius); background: linear-gradient(45deg, var(--accent), var(--accent-dark)); box-shadow: 0 4px 8px var(--shadow-strong); transition: transform var(--transition-fast) ease-in-out, box-shadow var(--transition-fast) ease-in-out, background var(--transition-fast) ease-in-out; z-index: 1; cursor: pointer; border: 0; }
    .btn:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 20px var(--shadow-strong); background: linear-gradient(45deg, var(--accent-dark), var(--accent)); }
    .btn.secondary { background: linear-gradient(45deg, var(--cta), var(--cta-dark)); }

    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row .btn { flex: 1 1 160px; text-align: center; }

    #preview { height: 560px; background: #0b0f14; border-radius: var(--radius); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04); position: relative; overflow: hidden; }
    #canvas3d { width: 100%; height: 100%; display: block; }

    .subtle { font-size: 0.85rem; color: var(--text-light); }
    .metrics { margin-top: 10px; font-family: 'Montserrat', sans-serif; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .metric { background: #f7f8fa; border-radius: 10px; padding: 10px; text-align: center; }
    .metric b { display: block; font-size: 0.9rem; color: var(--accent-dark); }

    footer { background: var(--dark-bg); color: #ccc; text-align: center; padding: 1.5rem var(--gap); font-size: 0.9rem; }
    footer a { color: var(--accent); }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal.active { display: flex; }
    .modal-card { background: var(--white); width: min(92vw, 980px); border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 1rem; }
    .modal-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.6rem; }
    .modal-body { display: grid; grid-template-columns: 1fr 380px; gap: 12px; }
    @media(max-width: 1024px){ .modal-body { grid-template-columns: 1fr; } }
    .cropper-wrap { background: #111; min-height: 360px; border-radius: 8px; overflow: hidden; display: grid; place-items: center; }
    .cropper-wrap img { max-width: 100%; display: block; }
  </style>
</head>
<body>
  <div class="notification" id="notification"></div>

  <header>
    <nav class="navbar">
      <div class="logo">Litho3D</div>
      <ul class="nav-links">
        <li><a href="/index.html">Home</a></li>
        <li><a href="#designer">Designer</a></li>
        <li><a href="#how">How it works</a></li>
        <li><a href="#faq">FAQ</a></li>
        <li><a class="cta" href="#export">Export</a></li>
      </ul>
      <div class="hamburger"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
    </nav>
  </header>

  <section id="designer">
    <h2>Design Your Lithophane</h2>
    <p class="lead">Upload a photo, crop it, tune thickness mapping, choose size, and preview a curved or flat panel. Export an STL that is ready to slice.</p>

    <div class="designer-wrap">
      <div class="panel">
        <h3>Image</h3>
        <div class="field wide">
          <label for="imgInput">Select JPG or PNG. Use high contrast for best results.</label>
          <input id="imgInput" type="file" accept="image/*" />
        </div>
        <div class="row">
          <button id="btnCrop" class="btn" disabled>Open cropper</button>
          <button id="btnAuto" class="btn" disabled>Auto enhance</button>
        </div>

        <h3 style="margin-top:14px">Size and resolution</h3>
        <div class="field"><label>Width mm</label><input id="mmW" type="number" min="20" max="300" step="1" value="120"/></div>
        <div class="field"><label>Height mm</label><input id="mmH" type="number" min="20" max="300" step="1" value="90"/></div>
        <div class="field"><label>Pixels per mm</label><input id="ppm" type="number" min="1" max="5" step="0.5" value="2"/></div>

        <h3 style="margin-top:14px">Thickness mapping</h3>
        <div class="field"><label>Min thickness mm</label><input id="tMin" type="number" min="0.6" max="3.0" step="0.1" value="0.8"/></div>
        <div class="field"><label>Max thickness mm</label><input id="tMax" type="number" min="1.0" max="6.0" step="0.1" value="3.2"/></div>
        <div class="field"><label>Gamma</label><input id="gamma" type="number" min="0.2" max="3.0" step="0.1" value="1.4"/></div>
        <div class="field"><label>Invert lights and darks</label><input id="invert" type="checkbox"/></div>
        <div class="field"><label>Flip for backlighting</label><input id="flipY" type="checkbox"/></div>

        <h3 style="margin-top:14px">Shape and border</h3>
        <div class="field"><label>Cylinder radius mm (0 is flat)</label><input id="radius" type="number" min="0" max="400" step="1" value="0"/></div>
        <div class="field"><label>Border width mm</label><input id="bWidth" type="number" min="0" max="10" step="0.5" value="2"/></div>
        <div class="field"><label>Border height mm</label><input id="bHeight" type="number" min="0" max="8" step="0.5" value="2"/></div>

        <div class="row" style="margin-top:10px">
          <button id="btnPreview" class="btn">Generate preview</button>
          <button id="btnExport" class="btn secondary" disabled>Download STL</button>
          <button id="btnHeightmap" class="btn" disabled>Download heightmap</button>
        </div>

        <div class="metrics">
          <div class="metric"><b>Triangles</b><span id="mTris">0</span></div>
          <div class="metric"><b>Volume cm³</b><span id="mVol">0.00</span></div>
          <div class="metric"><b>Mass g</b><span id="mMass">0.00</span></div>
        </div>
        <p class="subtle">Mass estimate assumes PLA at 1.24 g per cm³. This is a rough estimate only.</p>
      </div>

      <div id="preview" class="panel">
        <canvas id="canvas3d"></canvas>
      </div>
    </div>
  </section>

  <section id="how">
    <h2>How it works</h2>
    <p class="lead">The tool maps image luminance to thickness. Bright pixels become thin plastic. Dark pixels become thick plastic. Backlight creates contrast in the final print.</p>
  </section>

  <section id="faq">
    <h2>FAQ</h2>
    <p class="lead">Why does my preview look soft. Increase pixels per mm or use a higher resolution image. Why is my STL large. Try lower pixels per mm or smaller width and height.</p>
  </section>

  <section id="export">
    <h2>Export</h2>
    <p class="lead">Use the STL with your slicer. Print with white or natural PLA. A strong LED panel behind the print gives the best glow.</p>
  </section>

  <footer>
    <p>© 2025 Litho3D. All rights reserved. <a href="mailto:sunmayp@gmail.com">sunmayp@gmail.com</a></p>
  </footer>

  <div class="modal" id="cropperModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3 style="margin:0">Crop and adjust</h3>
        <button id="closeCrop" class="btn" style="padding:0.4rem 0.7rem">Close</button>
      </div>
      <div class="modal-body">
        <div class="cropper-wrap"><img id="cropImg" alt="crop source"/></div>
        <div class="panel">
          <div class="row">
            <button id="cropRotateL" class="btn">Rotate left</button>
            <button id="cropRotateR" class="btn">Rotate right</button>
            <button id="cropReset" class="btn">Reset</button>
          </div>
          <div class="field"><label>Aspect lock</label>
            <select id="aspect">
              <option value="free">Free</option>
              <option value="4:3">4:3</option>
              <option value="3:2">3:2</option>
              <option value="16:9">16:9</option>
              <option value="1:1">1:1</option>
            </select>
          </div>
          <div class="row">
            <button id="applyCrop" class="btn secondary">Apply crop</button>
          </div>
          <p class="subtle">Tip. Crop tight around the subject for better contrast.</p>
        </div>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
<link href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/STLExporter.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/BufferGeometryUtils.js"></script>

<script>
/* ======= NAV ======= */
const ham=document.querySelector('.hamburger');
const nav=document.querySelector('.nav-links');
if(ham)ham.addEventListener('click',()=>{ham.classList.toggle('active');nav.classList.toggle('active');});

/* ======= UI HELPERS ======= */
const notify=(msg,type='success')=>{
  const el=document.getElementById('notification');
  el.textContent=msg;el.className=`notification ${type}`;
  setTimeout(()=>{el.className='notification hide';setTimeout(()=>{el.className='notification';el.textContent='';},300);},2600);
};

/* ======= AUTO ENHANCE FIXED ======= */
const btnAuto=document.getElementById('btnAuto');
btnAuto.disabled=false;
btnAuto.addEventListener('click',()=>{
  if(!cropDataURL&&!srcImage)return notify("Load an image first","error");
  const img=new Image();
  img.onload=()=>{
    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d');
    canvas.width=img.width;canvas.height=img.height;
    ctx.drawImage(img,0,0);
    const data=ctx.getImageData(0,0,canvas.width,canvas.height);
    const pixels=data.data;
    let min=255,max=0;
    for(let i=0;i<pixels.length;i+=4){
      const v=0.299*pixels[i]+0.587*pixels[i+1]+0.114*pixels[i+2];
      if(v<min)min=v;if(v>max)max=v;
    }
    const range=max-min;
    for(let i=0;i<pixels.length;i+=4){
      pixels[i]=((pixels[i]-min)/range)*255;
      pixels[i+1]=((pixels[i+1]-min)/range)*255;
      pixels[i+2]=((pixels[i+2]-min)/range)*255;
    }
    ctx.putImageData(data,0,0);
    cropDataURL=canvas.toDataURL('image/png',1.0);
    srcImage.src=cropDataURL; // update preview image reference
    if(cropper){cropper.replace(cropDataURL);}
    btnAuto.classList.add("justEnhanced");
    notify("Auto enhance applied");
  };
  img.src=cropDataURL||srcImage.src;
});

/* ======= ELEMENTS ======= */
const imgInput=document.getElementById('imgInput');
const btnCrop=document.getElementById('btnCrop');
const btnPreview=document.getElementById('btnPreview');
const btnExport=document.getElementById('btnExport');
const mmW=document.getElementById('mmW');
const mmH=document.getElementById('mmH');
const ppm=document.getElementById('ppm');
const tMin=document.getElementById('tMin');
const tMax=document.getElementById('tMax');
const gamma=document.getElementById('gamma');
const invert=document.getElementById('invert');
const bWidth=document.getElementById('bWidth');
const bHeight=document.getElementById('bHeight');
let srcImage=null,cropDataURL=null;

/* ======= CROPPER ======= */
const cropperModal=document.getElementById('cropperModal');
const cropImg=document.getElementById('cropImg');
const closeCrop=document.getElementById('closeCrop');
const applyCrop=document.getElementById('applyCrop');
let cropper=null;

imgInput.addEventListener('change',e=>{
  const f=e.target.files[0];
  if(!f)return;
  const url=URL.createObjectURL(f);
  const img=new Image();
    img.onload=()=>{
    srcImage=img;
    cropDataURL=img.src;
    btnCrop.disabled=false;
    if(!btnAuto.classList.contains("justEnhanced")) {
        notify('Image loaded');
    }
    btnAuto.classList.remove("justEnhanced");
    };
  img.src=url;
});

btnCrop.addEventListener('click',()=>{
  if(!srcImage)return;
  cropperModal.classList.add('active');
  cropImg.src=cropDataURL;
  setTimeout(()=>{
    if(cropper)cropper.destroy();
    cropper=new Cropper(cropImg,{viewMode:1,dragMode:'move',autoCropArea:1});
  },50);
});
closeCrop.addEventListener('click',()=>cropperModal.classList.remove('active'));
applyCrop.addEventListener('click',()=>{
  if(!cropper)return;
  const cvs=cropper.getCroppedCanvas({imageSmoothingQuality:'high'});
  cropDataURL=cvs.toDataURL('image/png',1.0);
  srcImage.src=cropDataURL;
  cropperModal.classList.remove('active');
  notify('Crop applied');
});

/* ======= THREE.JS SETUP ======= */
const canvas3d=document.getElementById("canvas3d");
const previewPanel=document.getElementById("preview");

const renderer=new THREE.WebGLRenderer({canvas:canvas3d,antialias:true,preserveDrawingBuffer:true});
renderer.setClearColor(0x0b0f14,1);
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x0b0f14);

const camera=new THREE.PerspectiveCamera(45,1,0.1,5000);
camera.position.set(0,140,280);
camera.lookAt(0,70,0);

const orbit=new THREE.OrbitControls(camera,canvas3d);
orbit.enableDamping=true;orbit.dampingFactor=0.08;orbit.target.set(0,70,0);

const transform=new THREE.TransformControls(camera,renderer.domElement);
scene.add(transform);
transform.addEventListener("dragging-changed",e=>(orbit.enabled=!e.value));

scene.add(new THREE.AmbientLight(0xffffff,0.5));
const dir=new THREE.DirectionalLight(0xffffff,1.2);
dir.position.set(260,320,220);
scene.add(dir);
scene.add(new THREE.GridHelper(600,30,0x333333,0x555555));

const floor=new THREE.Mesh(new THREE.PlaneGeometry(2000,2000),new THREE.MeshPhongMaterial({color:0x050608}));
floor.rotation.x=-Math.PI/2;scene.add(floor);

let lithoGroup=new THREE.Group();
scene.add(lithoGroup);

function resizeRenderer(){
  const rect=previewPanel.getBoundingClientRect();
  renderer.setSize(rect.width,rect.height);
  camera.aspect=rect.width/rect.height;
  camera.updateProjectionMatrix();
}
window.addEventListener("resize",resizeRenderer);
resizeRenderer();

function animate(){
  requestAnimationFrame(animate);
  orbit.update();
  renderer.render(scene,camera);
}
animate();

function clearGroup(g){while(g.children.length)g.remove(g.children[0]);}

/* ======= HISTORY ======= */
let history=[],redoStack=[];
function captureState(obj){if(!obj)return;history.push(obj.matrix.clone());if(history.length>200)history.shift();redoStack=[];}
function applyMatrix(obj,m){obj.matrix.copy(m);obj.matrix.decompose(obj.position,obj.quaternion,obj.scale);}
window.addEventListener("keydown",e=>{
  const obj=transform.object;if(!obj)return;
  if(e.key.toLowerCase()==="w")transform.setMode("translate");
  if(e.key.toLowerCase()==="e")transform.setMode("scale");
  if(e.key.toLowerCase()==="r")transform.setMode("rotate");
  if(e.ctrlKey&&e.key.toLowerCase()==="z"&&history.length>1){redoStack.push(history.pop());applyMatrix(obj,history[history.length-1]);}
  if(e.ctrlKey&&e.key.toLowerCase()==="y"&&redoStack.length){const m=redoStack.pop();history.push(m.clone());applyMatrix(obj,m);}
  if(e.key.toLowerCase()==="d"){const box=new THREE.Box3().setFromObject(obj);obj.position.y-=box.min.y;obj.updateMatrixWorld(true);notify("Dropped to floor");}
});
let preGesture=null;
transform.addEventListener("mouseDown",()=>{if(transform.object)preGesture=transform.object.matrix.clone();});
transform.addEventListener("mouseUp",()=>{if(transform.object){if(preGesture)history.push(preGesture);history.push(transform.object.matrix.clone());preGesture=null;}});

/* ======= LITHOPHANE BUILDER (FLAT BACK) ======= */
async function buildLithophane(imgURL){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      const Wmm=parseFloat(mmW.value);
      const arImg=img.naturalWidth/img.naturalHeight;
      const Hmm=Wmm/arImg;mmH.value=Hmm.toFixed(1);
      const PPM=Math.max(1,parseFloat(ppm.value));
      const pxW=Math.floor(Wmm*PPM);
      const pxH=Math.floor(Hmm*PPM);
      const c=document.createElement("canvas");
      c.width=pxW;c.height=pxH;
      const ctx=c.getContext("2d",{willReadFrequently:true});
      ctx.drawImage(img,0,0,pxW,pxH);
      const rgba=ctx.getImageData(0,0,pxW,pxH).data;
      const g=new Float32Array(pxW*pxH);
      for(let i=0,p=0;i<g.length;i++,p+=4){
        let v=0.2126*rgba[p]+0.7152*rgba[p+1]+0.0722*rgba[p+2];
        v/=255;v=Math.pow(v,parseFloat(gamma.value));
        if(invert.checked)v=1-v;g[i]=v;
      }
      const minV=Math.min(...g),maxV=Math.max(...g);
      const span=Math.max(1e-6,maxV-minV);
      for(let i=0;i<g.length;i++)g[i]=(g[i]-minV)/span;
      const tMinV=Math.max(0.8,parseFloat(tMin.value));
      const tMaxV=Math.max(tMinV+1.5,parseFloat(tMax.value));
      const BW=Math.max(0,parseFloat(bWidth.value));
      const BH=Math.max(0,parseFloat(bHeight.value));
      const base=tMinV,depth=tMaxV-tMinV;

      const geo=new THREE.PlaneGeometry(Wmm,Hmm,pxW-1,pxH-1);
      const pos=geo.attributes.position;
      for(let iy=0;iy<pxH;iy++){
        for(let ix=0;ix<pxW;ix++){
          const idx=iy*pxW+ix;
            const z = (1 - g[idx]) * depth + 0.001; // lift ever so slightly so back touches frame
          pos.setZ(idx,z);
        }
      }
      pos.needsUpdate=true;geo.computeVertexNormals();

      // Create a bottom flat base that extends under the frame
        // Make the back flush with the lowest surface
        const bottomGeo = new THREE.PlaneGeometry(Wmm, Hmm);
        bottomGeo.rotateY(Math.PI); // ensure correct normal direction
        bottomGeo.translate(0, 0, tMinV);


      const g1=geo.clone().toNonIndexed();
      const g2=bottomGeo.toNonIndexed();
      const mergedGeo=THREE.BufferGeometryUtils.mergeBufferGeometries([g1,g2],false);
      const mat=new THREE.MeshPhongMaterial({color:0xffd700,shininess:60,side:THREE.DoubleSide});
      let merged=new THREE.Mesh(mergedGeo,mat);

      if(BW>0&&BH>0){
        const outerW=Wmm+2*BW,outerH=Hmm+2*BW;
        const shape=new THREE.Shape();
        shape.moveTo(-outerW/2,-outerH/2);
        shape.lineTo(outerW/2,-outerH/2);
        shape.lineTo(outerW/2,outerH/2);
        shape.lineTo(-outerW/2,outerH/2);
        shape.lineTo(-outerW/2,-outerH/2);
        const hole=new THREE.Path();
        hole.moveTo(-Wmm/2,-Hmm/2);
        hole.lineTo(Wmm/2,-Hmm/2);
        hole.lineTo(Wmm/2,Hmm/2);
        hole.lineTo(-Wmm/2,Hmm/2);
        hole.lineTo(-Wmm/2,-Hmm/2);
        shape.holes.push(hole);
        const extrude = new THREE.ExtrudeGeometry(shape, {steps:1, depth:BH, bevelEnabled:false});
        extrude.translate(0, 0, -0.001); // frame exactly flush, no offset subtraction

        const frame=new THREE.Mesh(extrude,mat);
        const mg=THREE.BufferGeometryUtils.mergeBufferGeometries(
          [merged.geometry.clone().toNonIndexed(),frame.geometry.clone().toNonIndexed()],
          false
        );
        merged=new THREE.Mesh(mg,mat);
      }

      const box=new THREE.Box3().setFromObject(merged);
      merged.position.y-=box.min.y;
      resolve({group:merged});
    };
    img.onerror=reject;
    img.src=imgURL;
  });
}

/* ======= PREVIEW + EXPORT ======= */
btnPreview.addEventListener("click",async()=>{
  const srcURL=cropDataURL||(srcImage&&srcImage.src);
  if(!srcURL)return notify("Select an image first","error");
  notify("Generating preview...");
  const {group}=await buildLithophane(srcURL);
  clearGroup(lithoGroup);lithoGroup.add(group);
  transform.detach();transform.attach(group);
  group.updateMatrix();captureState(group);
  // Update metrics
    const box = new THREE.Box3().setFromObject(group);
    const size = new THREE.Vector3();
    box.getSize(size);
    const volume = size.x * size.y * size.z / 1000; // mm³ → cm³
    document.getElementById("mVol").textContent = volume.toFixed(2);
    document.getElementById("mMass").textContent = (volume * 1.24).toFixed(2);
    const tris = group.geometry ? group.geometry.attributes.position.count / 3 : 0;
    document.getElementById("mTris").textContent = tris.toLocaleString();

  btnExport.disabled=false;
  notify("Preview ready. Flat back + full frame.");
});

btnExport.addEventListener("click",async()=>{
  const srcURL=cropDataURL||(srcImage&&srcImage.src);
  if(!srcURL)return notify("Select an image first","error");
  notify("Building STL...");
  const {group}=await buildLithophane(srcURL);
  if(transform.object){
    group.position.copy(transform.object.position);
    group.quaternion.copy(transform.object.quaternion);
    group.scale.copy(transform.object.scale);
  }
  const exporter=new THREE.STLExporter();
  const stl=exporter.parse(group);
  const blob=new Blob([stl],{type:"application/sla"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`litho_${Date.now()}.stl`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),2000);
  notify("STL downloaded");
});
// Attach cropper control buttons
document.getElementById('cropRotateL').onclick = () => cropper.rotate(-90);
document.getElementById('cropRotateR').onclick = () => cropper.rotate(90);
document.getElementById('cropReset').onclick   = () => cropper.reset();

</script>


</body>
</html>
